name: Decompile XAPK with JADX

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  decompile:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download XAPK file
        run: |
          Invoke-WebRequest -Uri "https://github.com/SuperiorTeam09/Library/releases/download/Main/Groovepad.xapk" -OutFile "Groovepad.xapk"
        shell: pwsh
      
      - name: Extract XAPK
        run: |
          Expand-Archive -Path "Groovepad.xapk" -DestinationPath "xapk_extracted"
        shell: pwsh
      
      - name: Download JADX
        run: |
          $latestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/skylot/jadx/releases/latest"
          $jadxAsset = $latestRelease.assets | Where-Object { $_.name -like "jadx-*.zip" -and $_.name -notlike "*-with-jre-*" } | Select-Object -First 1
          Write-Host "Downloading JADX: $($jadxAsset.name)"
          Invoke-WebRequest -Uri $jadxAsset.browser_download_url -OutFile "jadx.zip"
          Expand-Archive -Path "jadx.zip" -DestinationPath "jadx"
        shell: pwsh
      
      - name: Find and Decompile APK files
        run: |
          $apkFiles = Get-ChildItem -Path "xapk_extracted" -Filter "*.apk" -Recurse
          New-Item -ItemType Directory -Path "decompiled" -Force
          
          foreach ($apk in $apkFiles) {
            $outputDir = "decompiled/$($apk.BaseName)"
            Write-Host "Decompiling $($apk.Name)..."
            & "jadx\bin\jadx.bat" -d $outputDir $apk.FullName
          }
        shell: pwsh
      
      - name: Zip decompiled output
        run: |
          Compress-Archive -Path "decompiled\*" -DestinationPath "Groovepad-decompiled.zip"
        shell: pwsh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: groovepad-decompiled
          path: Groovepad-decompiled.zip
          retention-days: 30
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: decompiled-${{ github.run_number }}
          release_name: Groovepad Decompiled - Build ${{ github.run_number }}
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./Groovepad-decompiled.zip
          asset_name: Groovepad-decompiled.zip
          asset_content_type: application/zip
